<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Neuro Evolution Sandbox (Stable + Persistent)</title>

<style>
html, body { margin:0; padding:0; background:#111; overflow:hidden; font-family:system-ui; }
canvas { display:block; }

#hud{
  position:fixed; left:10px; top:10px;
  color:#ddd; font-size:13px;
  background:rgba(0,0,0,0.7);
  padding:10px; border-radius:10px;
  max-width:520px;
}

#fitnessGraph{
  position:fixed; right:10px; top:10px;
  width:520px; height:320px;
  background:#000;
  border-radius:10px;
  padding:10px;
  display:none;
}

#creatureInfo{
  position:fixed; left:10px; bottom:10px;
  width:320px;
  background:#000;
  padding:10px;
  border-radius:10px;
  display:none;
}

button{ background:#444; color:#fff; border:1px solid #666; border-radius:5px; font-size:11px; padding:4px 8px; }
button:hover{ background:#555; }
</style>
</head>

<body>
<div id="hud"></div>
<canvas id="c"></canvas>

<div id="fitnessGraph">
  <button onclick="toggleGraph()">Close</button>
  <canvas id="graphCanvas" width="500" height="260"></canvas>
</div>

<div id="creatureInfo">
  <div id="creatureStats"></div>
  <canvas id="barcodeCanvas" width="300" height="24"></canvas>
</div>

<script>
(() => {

/* ================= CONFIG ================= */

const cfg = {
  W: innerWidth, H: innerHeight,
  PREY_INIT:40, PREY_MIN:30, PREY_MAX:70,
  PRED_INIT:4,  PRED_MIN:3,  PRED_MAX:10,
  FOOD_CLUSTERS:6, FOOD_PER_CLUSTER:18, FOOD_RADIUS:160, FOOD_ENERGY:26,
  DT:1/60,
  SPEED_LIMIT:80, ACCEL:110, TURN_LIMIT:4.5, TURN_ACCEL:6.5, FRICTION:0.985,
  BOOST_MULT:3, BOOST_COST:18, BOOST_COOLDOWN:2.5,
  BRAKE_FORCE:0.25, BRAKE_COST:6, BRAKE_COOLDOWN:1.5,
  ENERGY_INIT:70, ENERGY_MAX:160, ENERGY_DECAY:2.2,
  ENERGY_MOVE_COST:0.012, ENERGY_TURN_COST:0.35,
  REPRO_THRESHOLD:120, REPRO_COST:55, REPRO_COOLDOWN:3,
  MUT_RATE:0.12, MUT_SCALE:0.4, WEIGHT_CLAMP:3,
  SENSE_RADIUS:240, EAT_RADIUS:8,
  ATTACK_RADIUS:10, ATTACK_DRAIN:32, ATTACK_GAIN:28, ATTACK_COOLDOWN:0.5,
  N_IN:12, N_H:8, N_OUT:4
};

const CONFIG_HASH = `${cfg.N_IN}-${cfg.N_H}-${cfg.N_OUT}`;

/* ================= CANVAS ================= */

const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");
const hud = document.getElementById("hud");

function resize(){
  canvas.width = cfg.W = innerWidth;
  canvas.height = cfg.H = innerHeight;
}
addEventListener("resize", resize);
resize();

/* ================= UTIL ================= */

const rand=(a=0,b=1)=>a+Math.random()*(b-a);
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const len=(x,y)=>Math.hypot(x,y);
const wrap=(x,m)=>x<0?x+m:(x>=m?x-m:x);
const sigmoid=x=>1/(1+Math.exp(-x));
const tanh=Math.tanh;

/* ================= BRAIN ================= */

class Brain{
  constructor(w=null){
    this.w = w ? w.slice() : Array.from({length:this.count()},()=>rand(-1,1));
  }
  count(){ return cfg.N_H*(cfg.N_IN+1) + cfg.N_OUT*(cfg.N_H+1); }
  forward(inp){
    let i=0, h=[];
    for(let n=0;n<cfg.N_H;n++){
      let s=0; for(let k=0;k<cfg.N_IN;k++) s+=this.w[i++]*inp[k];
      h[n]=tanh(s+this.w[i++]);
    }
    let out=[];
    for(let o=0;o<cfg.N_OUT;o++){
      let s=0; for(let k=0;k<cfg.N_H;k++) s+=this.w[i++]*h[k];
      out[o]=s+this.w[i++];
    }
    return [sigmoid(out[0]), tanh(out[1]), sigmoid(out[2]), sigmoid(out[3])];
  }
  static crossover(a,b){
    const p=Math.floor(rand(1,a.length-1));
    return a.map((v,i)=>i<p?v:b[i]);
  }
  static mutate(w){
    return w.map(v=>{
      if(Math.random()<cfg.MUT_RATE)
        v=clamp(v+rand(-1,1)*cfg.MUT_SCALE,-cfg.WEIGHT_CLAMP,cfg.WEIGHT_CLAMP);
      return v;
    });
  }
}

/* ================= GENETIC BARCODE ================= */

const BARCODE_LEN = cfg.N_H;

function mixBarcode(a,b){
  return a.map((_,i)=>Math.random()<0.5?a[i]:b[i]);
}

/* ================= CREATURE ================= */

let nextId=1;

class Creature{
  constructor(species,w=null,parents=null,generation=0){
    this.id=nextId++;
    this.species=species;
    this.x=rand(0,cfg.W); this.y=rand(0,cfg.H);
    this.vx=0; this.vy=0; this.angle=rand(0,Math.PI*2); this.omega=0;
    this.energy=cfg.ENERGY_INIT; this.score=0; this.age=0;
    this.cooldown=0; this.boostCD=0; this.brakeCD=0; this.attackCD=0;
    this.brain=new Brain(w); this.genome=this.brain.w;
    this.parents=parents; this.generation=generation;

    const color=`hsl(${(this.id*137.5)%360},70%,50%)`;
    this.barcode = parents ? mixBarcode(parents[0].barcode, parents[1].barcode)
                            : Array(BARCODE_LEN).fill(color);
  }

  sense(target){
    const dx=target?target.x-this.x:0, dy=target?target.y-this.y:0;
    const d=Math.min(len(dx,dy),cfg.SENSE_RADIUS);
    return [dx/d||0, dy/d||0, 1-d/cfg.SENSE_RADIUS,
            this.energy/cfg.ENERGY_MAX, Math.cos(this.angle), Math.sin(this.angle)];
  }

  step(target){
    const [thrust,turn]=this.brain.forward(this.sense(target));
    this.omega=clamp(this.omega+turn*cfg.TURN_ACCEL*cfg.DT,-cfg.TURN_LIMIT,cfg.TURN_LIMIT);
    this.angle+=this.omega*cfg.DT;
    this.vx+=Math.cos(this.angle)*thrust*cfg.ACCEL*cfg.DT;
    this.vy+=Math.sin(this.angle)*thrust*cfg.ACCEL*cfg.DT;
    const sp=len(this.vx,this.vy);
    if(sp>cfg.SPEED_LIMIT){this.vx*=cfg.SPEED_LIMIT/sp;this.vy*=cfg.SPEED_LIMIT/sp;}
    this.x=wrap(this.x+this.vx*cfg.DT,cfg.W);
    this.y=wrap(this.y+this.vy*cfg.DT,cfg.H);
    this.vx*=cfg.FRICTION; this.vy*=cfg.FRICTION;
    this.score+=Math.max(0,sp)*0.0006;
    this.energy=clamp(this.energy-cfg.ENERGY_DECAY*cfg.DT,0,cfg.ENERGY_MAX);
    this.age+=cfg.DT;
  }

  draw(){
    ctx.save();
    ctx.translate(this.x,this.y);
    ctx.rotate(this.angle);
    ctx.fillStyle=this.barcode[0];
    ctx.beginPath();
    ctx.moveTo(8,0); ctx.lineTo(-6,4); ctx.lineTo(-6,-4); ctx.closePath();
    ctx.fill();
    ctx.restore();
  }
}

/* ================= WORLD ================= */

let prey=[];
function init(){
  prey=[];
  const saved=loadBest("prey");
  if(saved) prey.push(new Creature("prey",saved.genome,null,saved.generation));
  while(prey.length<cfg.PREY_INIT) prey.push(new Creature("prey"));
}
init();

/* ================= GRAPH ================= */

const graphCanvas=document.getElementById("graphCanvas");
const gctx=graphCanvas.getContext("2d");
const fitnessHistory={t:[],best:[]};
const MAX_POINTS=1200;

function addGraphPoint(t,v){
  fitnessHistory.t.push(t);
  fitnessHistory.best.push(v);
  if(fitnessHistory.t.length>MAX_POINTS){
    fitnessHistory.t=fitnessHistory.t.filter((_,i)=>i%2===0);
    fitnessHistory.best=fitnessHistory.best.filter((_,i)=>i%2===0);
  }
}

function drawGraph(){
  gctx.clearRect(0,0,500,260);
  const max=Math.max(...fitnessHistory.best,10);
  fitnessHistory.t.forEach((t,i)=>{
    const x=i/fitnessHistory.t.length*500;
    const y=260-(fitnessHistory.best[i]/max)*260;
    gctx.fillStyle="#0f0";
    gctx.fillRect(x,y,2,2);
  });
}

window.toggleGraph=()=>document.getElementById("fitnessGraph").style.display^="block";

/* ================= PERSISTENCE ================= */

function recordBest(c){
  localStorage.setItem("best_prey",JSON.stringify({
    genome:[...c.genome], fitness:c.score, generation:c.generation, config:CONFIG_HASH
  }));
}

function loadBest(){
  const r=localStorage.getItem("best_prey");
  if(!r) return null;
  const o=JSON.parse(r);
  if(o.config!==CONFIG_HASH) return null;
  return o;
}

/* ================= CLICK ================= */

canvas.onclick=e=>{
  const r=canvas.getBoundingClientRect();
  const x=e.clientX-r.left,y=e.clientY-r.top;
  let best=null,d=20;
  prey.forEach(c=>{
    const dd=len(x-c.x,y-c.y);
    if(dd<d){d=dd;best=c;}
  });
  if(best){
    document.getElementById("creatureInfo").style.display="block";
    document.getElementById("creatureStats").innerHTML=
      `ID ${best.id}<br>Fitness ${best.score.toFixed(2)}<br>Gen ${best.generation}`;
    const bc=document.getElementById("barcodeCanvas").getContext("2d");
    bc.clearRect(0,0,300,24);
    best.barcode.forEach((col,i)=>{
      bc.fillStyle=col;
      bc.fillRect(i*300/best.barcode.length,0,300/best.barcode.length,24);
    });
  }
};

/* ================= TICK ================= */

let t=0, lastGraph=0;
function tick(){
  t+=cfg.DT;
  ctx.clearRect(0,0,cfg.W,cfg.H);
  prey.forEach(c=>{
    c.step(null);
    if(c.score>bestFitness){bestFitness=c.score;recordBest(c);}
    c.draw();
  });
  if(t-lastGraph>60){lastGraph=t;addGraphPoint(t,bestFitness);drawGraph();}
  hud.innerHTML=`Time ${t.toFixed(0)} | Best ${bestFitness.toFixed(2)}`;
  requestAnimationFrame(tick);
}
let bestFitness=0;
tick();

})();
</script>
</body>
</html>
